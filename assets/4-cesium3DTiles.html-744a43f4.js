import{_ as e,r as o,o as c,c as i,b as n,d as s,e as t,a as p}from"./app-fdb0ca41.js";const l="/ahana-docs/webgl/cesium/4-13.jpg",u="/ahana-docs/webgl/cesium/4-14.jpg",r="/ahana-docs/webgl/cesium/4-15.jpg",k="/ahana-docs/webgl/cesium/4-16.jpg",d="/ahana-docs/webgl/cesium/4-17.gif",m={},v=n("h1",{id:"_4-cesium3dtiles",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_4-cesium3dtiles","aria-hidden":"true"},"#"),s(" 4-cesium3DTiles")],-1),b=n("h2",{id:"_3d-tiles-是什么",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3d-tiles-是什么","aria-hidden":"true"},"#"),s(" 3D Tiles 是什么")],-1),h=n("p",null,"3DTiles数据集是cesium小组AnalyticlGraphics与2016年3月定义的一种数据集，3DTiles数据集以分块、分级渲染，将大数据量三维数据以分块，分层的形式组织起来，可以大量减轻浏览器和GPU的负担是一个优秀的，并且格式公开的数据格式。",-1),f=n("p",null,"3D Tiles将用于流式传输3D内容，包括建筑物，树木，点云和矢量数据。",-1),g={href:"https://cesium.com/blog/2015/08/10/introducing-3d-tiles/",target:"_blank",rel:"noopener noreferrer"},x=p(`<h2 id="_3d-tiles" tabindex="-1"><a class="header-anchor" href="#_3d-tiles" aria-hidden="true">#</a> 3D Tiles</h2><p>3D Tiles将用于流式传输3D内容，包括建筑物，树木，点云和矢量数据。</p><p>contextCapture 可以将无人机成果转换成Cesium支持的倾斜摄影成果，当前例子就是使用的这种成果。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> tileset <span class="token operator">=</span> viewer<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Cesium<span class="token punctuation">.</span>Cesium3DTileset</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span> <span class="token comment">//数据路径</span>
    <span class="token literal-property property">maximumScreenSpaceError</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">//最大的屏幕空间误差</span>
    <span class="token literal-property property">maximumNumberOfLoadedTiles</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">//最大加载瓦片个数</span>
    <span class="token literal-property property">modelMatrix</span><span class="token operator">:</span> m <span class="token comment">//形状矩阵</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是问题在于生成的数据不一定是落在地面上，有可能是浮在空中的，例如：</p><p><img src="`+l+'" alt="3DTiles-4-13"></p><p>这并不是我们想要的,我们希望拍摄的成果能贴到地面上，和地图能很好的融合在一起，类似这样</p><p><img src="'+u+'" alt="3DTiles-4-14"></p><p>由于单个瓦片的位置信息是写到了数据中的(.b3dm和对应的json文件中),如果能整体调整加载后的tileset，就会是最好的选择，这里就要提到本文的主角：</p><h3 id="modelmatrix" tabindex="-1"><a class="header-anchor" href="#modelmatrix" aria-hidden="true">#</a> modelMatrix</h3><p>Cesium3DTile里面有一个属性，可以更改位置</p><p>transform : Matrix4 Scene/Cesium3DTile.js 88 The local transform of this tile</p><p>说明通过矩阵运算是可以调整整个数据的显示位置的</p><p>以下说明矩阵平移的情况：</p><h3 id="自己获取偏移量" tabindex="-1"><a class="header-anchor" href="#自己获取偏移量" aria-hidden="true">#</a> 自己获取偏移量</h3><p>参考《WebGl编程指南》的第三章第四章</p><p><img src="'+r+`" alt="3DTiles-4-15"></p><p>Tx,Ty,Tz就是我们需要设置的 x,y,z方向上的平移距离由于Cesium的矩阵是列主序的，所以这里写成</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">//创建平移矩阵方法一</span>
<span class="token comment">// m = Cesium.Matrix4.fromArray([</span>
<span class="token comment">// 1.0, 0.0, 0.0, 0.0,</span>
<span class="token comment">// 0.0, 1.0, 0.0, 0.0,</span>
<span class="token comment">// 0.0, 0.0, 1.0, 0.0,</span>
<span class="token comment">// x, y, z, 1.0</span>
<span class="token comment">// ]);</span>

<span class="token comment">//创建平移矩阵方法二</span>
<span class="token keyword">var</span> translation<span class="token operator">=</span>Cesium<span class="token punctuation">.</span>Cartesian3<span class="token punctuation">.</span><span class="token function">fromArray</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m<span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix4<span class="token punctuation">.</span><span class="token function">fromTranslation</span><span class="token punctuation">(</span>translation<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//生效</span>
tileset<span class="token punctuation">.</span>_modelMatrix <span class="token operator">=</span> m<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我们只需要不断的修改 x,y,z，就可以调整物体的位置了</p><p>获取 x,y,z 之后,在加载3D Tiles 时将modelMatrix 设置成目标 x,y,z值，就完成了</p><p><img src="`+k+'" alt="3DTiles-4-16"></p><h3 id="计算偏移量" tabindex="-1"><a class="header-anchor" href="#计算偏移量" aria-hidden="true">#</a> 计算偏移量</h3>',23),y={href:"https://cesiumjs.org/Cesium/Build/Apps/Sandcastle/index.html?src=3D%7Bac3c4da2cd0600a7fb5dd7ece3d30a0eed29da11cf2830143610191d982c65a1%7D20Tiles%7Bac3c4da2cd0600a7fb5dd7ece3d30a0eed29da11cf2830143610191d982c65a1%7D20Adjust%7Bac3c4da2cd0600a7fb5dd7ece3d30a0eed29da11cf2830143610191d982c65a1%7D20Height.html&label=3D%7Bac3c4da2cd0600a7fb5dd7ece3d30a0eed29da11cf2830143610191d982c65a1%7D20Tiles",target:"_blank",rel:"noopener noreferrer"},w=p(`<p>一步到位</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">//方法二，直接调用函数，调整高度,height表示物体离地面的高度</span>
<span class="token keyword">function</span> <span class="token function">changeHeight</span><span class="token punctuation">(</span><span class="token parameter">height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    height <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> cartographic <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Cartographic<span class="token punctuation">.</span><span class="token function">fromCartesian</span><span class="token punctuation">(</span>tileset<span class="token punctuation">.</span>boundingSphere<span class="token punctuation">.</span>center<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> surface <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Cartesian3<span class="token punctuation">.</span><span class="token function">fromRadians</span><span class="token punctuation">(</span>cartographic<span class="token punctuation">.</span>longitude<span class="token punctuation">,</span> cartographic<span class="token punctuation">.</span>latitude<span class="token punctuation">,</span> cartographic<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> offset <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Cartesian3<span class="token punctuation">.</span><span class="token function">fromRadians</span><span class="token punctuation">(</span>cartographic<span class="token punctuation">.</span>longitude<span class="token punctuation">,</span> cartographic<span class="token punctuation">.</span>latitude<span class="token punctuation">,</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> translation <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Cartesian3<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Cesium<span class="token punctuation">.</span>Cartesian3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tileset<span class="token punctuation">.</span>modelMatrix <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix4<span class="token punctuation">.</span><span class="token function">fromTranslation</span><span class="token punctuation">(</span>translation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="模型旋转" tabindex="-1"><a class="header-anchor" href="#模型旋转" aria-hidden="true">#</a> 模型旋转</h2><ol><li>根据要旋转的角度，构建一个三阶旋转矩阵</li><li>获取3D tiles 的旋转矩阵modelMatrix，然后与旋转矩阵运算</li><li>最后将计算结果再赋值给modelMatrix，完成</li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> m <span class="token operator">=</span> tileset<span class="token punctuation">.</span>modelMatrix<span class="token punctuation">;</span>
<span class="token comment">//RotateX为旋转角度，转为弧度再参与运算</span>
<span class="token keyword">var</span> m1 <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix3<span class="token punctuation">.</span><span class="token function">fromRotationX</span><span class="token punctuation">(</span>Cesium<span class="token punctuation">.</span>Math<span class="token punctuation">.</span><span class="token function">toRadians</span><span class="token punctuation">(</span>RotateX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//矩阵计算</span>
Cesium<span class="token punctuation">.</span>Matrix4<span class="token punctuation">.</span><span class="token function">multiplyByMatrix3</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>m1<span class="token punctuation">,</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//赋值</span>
tileset<span class="token punctuation">.</span>modelMatrix <span class="token operator">=</span> m<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> tileset <span class="token operator">=</span> viewer<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Cesium<span class="token punctuation">.</span>Cesium3DTileset</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">url</span> <span class="token operator">:</span> <span class="token string">&#39;Tileset/tileset.json&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">modelMatrix</span><span class="token operator">:</span>Cesium<span class="token punctuation">.</span>Matrix4<span class="token punctuation">.</span><span class="token constant">IDENTITY</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tileset<span class="token punctuation">.</span>readyPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> boundingSphere <span class="token operator">=</span> tileset<span class="token punctuation">.</span>boundingSphere<span class="token punctuation">;</span>
    viewer<span class="token punctuation">.</span>camera<span class="token punctuation">.</span><span class="token function">viewBoundingSphere</span><span class="token punctuation">(</span>boundingSphere<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Cesium<span class="token punctuation">.</span>HeadingPitchRange</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> boundingSphere<span class="token punctuation">.</span>radius <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    viewer<span class="token punctuation">.</span>camera<span class="token punctuation">.</span><span class="token function">lookAtTransform</span><span class="token punctuation">(</span>Cesium<span class="token punctuation">.</span>Matrix4<span class="token punctuation">.</span><span class="token constant">IDENTITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">otherwise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> m <span class="token operator">=</span> tileset<span class="token punctuation">.</span>modelMatrix<span class="token punctuation">;</span>

<span class="token keyword">var</span> anglex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">rotatex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    anglex <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> m1 <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix3<span class="token punctuation">.</span><span class="token function">fromRotationX</span><span class="token punctuation">(</span>Cesium<span class="token punctuation">.</span>Math<span class="token punctuation">.</span><span class="token function">toRadians</span><span class="token punctuation">(</span>anglex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    tileset<span class="token punctuation">.</span>modelMatrix <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix4<span class="token punctuation">.</span><span class="token function">multiplyByMatrix3</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>m1<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Cesium<span class="token punctuation">.</span>Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> angley <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">rotatey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    angley <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> m1 <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix3<span class="token punctuation">.</span><span class="token function">fromRotationY</span><span class="token punctuation">(</span>Cesium<span class="token punctuation">.</span>Math<span class="token punctuation">.</span><span class="token function">toRadians</span><span class="token punctuation">(</span>angley<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    tileset<span class="token punctuation">.</span>modelMatrix <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix4<span class="token punctuation">.</span><span class="token function">multiplyByMatrix3</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>m1<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Cesium<span class="token punctuation">.</span>Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> anglez <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">rotatez</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    anglez <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> m1 <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix3<span class="token punctuation">.</span><span class="token function">fromRotationZ</span><span class="token punctuation">(</span>Cesium<span class="token punctuation">.</span>Math<span class="token punctuation">.</span><span class="token function">toRadians</span><span class="token punctuation">(</span>anglez<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    tileset<span class="token punctuation">.</span>modelMatrix <span class="token operator">=</span> Cesium<span class="token punctuation">.</span>Matrix4<span class="token punctuation">.</span><span class="token function">multiplyByMatrix3</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>m1<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Cesium<span class="token punctuation">.</span>Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+d+'" alt="3DTiles-4-17"></p>',7);function _(C,M){const a=o("ExternalLinkIcon");return c(),i("div",null,[v,b,h,f,n("p",null,[n("a",g,[s("官网 3dtiles 介绍"),t(a)])]),x,n("p",null,[n("a",y,[s("官方示例"),t(a)])]),w])}const D=e(m,[["render",_],["__file","4-cesium3DTiles.html.vue"]]);export{D as default};
